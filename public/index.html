<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç§˜å¯†èŠå¤©å®¤</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#0d6efd" />
    <link rel="apple-touch-icon" href="/icon.png" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f0f2f5;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
      }

      /* === ç™»å…¥ç•«é¢ === */
      #login-view {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #0d6efd, #0dcaf0);
      }

      /* === èŠå¤©ç•«é¢ === */
      #chat-view {
        width: 100%;
        height: 100%;
        max-width: 600px; /* æ‰‹æ©Ÿç‰ˆå¯¬åº¦é™åˆ¶ */
        background: #fff;
        display: none; /* é è¨­éš±è— */
        flex-direction: column;
        position: relative;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      /* è¨Šæ¯å®¹å™¨ */
      #msg-container {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #eef1f5;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* è¨Šæ¯æ°£æ³¡ */
      .msg-row {
        display: flex;
        flex-direction: column;
        max-width: 75%;
        position: relative;
      }

      .msg-row.me {
        align-self: flex-end;
        align-items: flex-end;
      }

      .msg-row.other {
        align-self: flex-start;
        align-items: flex-start;
      }

      .msg-name {
        font-size: 12px;
        color: #666;
        margin-bottom: 2px;
        margin-left: 5px;
      }

      .bubble-wrapper {
        display: flex;
        align-items: flex-end; /* è®“æ™‚é–“é¡¯ç¤ºåœ¨æ°£æ³¡åº•éƒ¨ */
        gap: 5px;
      }

      .msg-row.me .bubble-wrapper {
        flex-direction: row-reverse; /* è‡ªå·±çš„è¨Šæ¯ï¼Œæ™‚é–“åœ¨å·¦é‚Š */
      }

      .bubble {
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.4;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .msg-row.me .bubble {
        background-color: #0084ff;
        color: white;
        border-bottom-right-radius: 4px;
      }

      .msg-row.other .bubble {
        background-color: #fff;
        color: #050505;
        border-bottom-left-radius: 4px;
      }

      /* åœ–ç‰‡èˆ‡å½±ç‰‡æ¨£å¼ */
      .msg-img,
      .msg-video {
        max-width: 200px;
        border-radius: 12px;
        cursor: pointer;
      }
      .sticker-img {
        width: 120px;
      }

      /* æ™‚é–“èˆ‡å·²è®€ */
      .msg-time {
        font-size: 10px;
        color: #aaa;
        min-width: 30px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        margin-bottom: 2px;
      }
      .read-status {
        font-size: 10px;
        color: #999;
        margin-bottom: 2px;
        text-align: right;
      }

      /* æ—¥æœŸåˆ†éš”ç·š */
      .date-divider {
        text-align: center;
        margin: 15px 0;
        position: relative;
      }
      .date-divider span {
        background: #e1e4e8;
        color: #666;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
      }

      /* ç³»çµ±è¨Šæ¯ */
      .system-notice {
        text-align: center;
        font-size: 12px;
        color: #888;
        margin: 10px 0;
      }

      /* åº•éƒ¨è¼¸å…¥å€ */
      .input-area {
        background: #fff;
        padding: 8px 10px; /* ä¸Šä¸‹ç¸®å°åˆ° 8pxï¼Œå·¦å³ 10px */
        display: flex;
        gap: 8px; /* å…ƒä»¶ä¹‹é–“çš„è·é›¢ */
        align-items: center; /* å‚ç›´ç½®ä¸­ */
        border-top: 1px solid #eee; /* åŠ ä¸€æ¢æ·¡æ·¡çš„åˆ†éš”ç·š */
        flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
      }

      /* è¼¸å…¥æ¡†æœ¬é«” */
      #msg-input {
        height: 40px; /* å¼·åˆ¶è¨­å®šé«˜åº¦ï¼Œä¸è®“å®ƒäº‚é•· */
        font-size: 15px; /* å­—é«”å¤§å°é©ä¸­ */
        padding: 0 15px; /* å·¦å³ç•™é»å‘¼å¸ç©ºé–“ */
      }

      /* æŒ‰éˆ•çµ±ä¸€åœ“å½¢æ¨£å¼ */
      .btn-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* é˜²æ­¢æŒ‰éˆ•è®Šå½¢ */
        border: none;
      }

      /* å‚³é€æŒ‰éˆ•é¡è‰² */
      .btn-send {
        background-color: #0084ff; /* Messenger è— */
        color: white;
      }
      .btn-send:hover {
        background-color: #0073e6;
      }
      .btn-send:active {
        transform: scale(0.95);
      } /* é»æ“Šç¸®æ”¾æ•ˆæœ */

      /* === è¦–è¨Šé€šè©±ä»‹é¢ (æ‡¸æµ®è¦–çª—) === */
      #call-overlay {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 300px;
        height: auto;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        padding: 10px;
        /* é è¨­éš±è— */
        /* display: none; ç”± d-none æ§åˆ¶ */
      }

      /* æ‰‹æ©Ÿç‰ˆï¼šç¸®å°é€šè©±è¦–çª— */
      @media (max-width: 768px) {
        #call-overlay {
          top: 10px;
          right: 10px;
          width: 160px;
          padding: 8px;
        }

        .video-container {
          margin-bottom: 6px;
        }

        #call-status {
          font-size: 0.7rem;
          margin-bottom: 6px !important;
        }

        .call-controls {
          flex-direction: column;
          gap: 5px;
          width: 100%;
        }

        .call-controls button {
          font-size: 0.65rem;
          padding: 5px 8px !important;
          width: 100%;
          margin: 0 !important;
        }

        #local-video {
          width: 45px;
          height: 34px;
        }

        .audio-only-placeholder {
          font-size: 0.9rem;
        }
      }

      .video-container {
        position: relative;
        width: 100%;
        /* max-width: 600px; */
        aspect-ratio: 4/3; /* æ”¹ç‚º 4:3 æ¯”è¼ƒé©åˆå°è¦–çª— */
        background: #000;
        margin-bottom: 10px;
        border-radius: 8px;
        overflow: hidden;
      }

      #remote-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      #local-video {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 80px;
        height: 60px;
        object-fit: cover;
        border: 2px solid white;
        border-radius: 6px;
        z-index: 2;
      }

      /* èªéŸ³é€šè©±æ¨¡å¼çš„ä½”ä½ç¬¦ */
      .audio-only-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 20px;
        background: #333;
        color: #fff;
        font-size: 1rem;
        z-index: 1;
        text-align: center;
      }

      .call-controls {
        display: flex;
        gap: 20px;
      }
    </style>
  </head>
  <body>
    <!-- === ç™»å…¥ç•«é¢ === -->
    <div id="login-view">
      <div
        class="card p-4 border-0 shadow-lg"
        style="width: 300px; border-radius: 20px"
      >
        <h3 class="text-center mb-4 fw-bold text-primary">ğŸ‘‹ æ­¡è¿å›ä¾†</h3>
        <input
          type="text"
          id="username"
          class="form-control mb-3 p-3"
          placeholder="å¸³è™Ÿ (admin/friend)"
        />
        <input
          type="password"
          id="password"
          class="form-control mb-4 p-3"
          placeholder="å¯†ç¢¼"
        />
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="remember-me" />
          <label class="form-check-label text-secondary" for="remember-me">
            è¨˜ä½æˆ‘ (è‡ªå‹•ç™»å…¥)
          </label>
        </div>
        <button
          onclick="doLogin()"
          class="btn btn-primary w-100 p-3 fw-bold rounded-pill"
        >
          ç™»å…¥èŠå¤©
        </button>
        <div class="mt-3 text-center">
          <button
            onclick="testCamera()"
            class="btn btn-sm btn-outline-secondary rounded-pill"
            style="font-size: 12px"
          >
            ğŸ¥ æ¸¬è©¦é¡é ­èˆ‡éº¥å…‹é¢¨
          </button>
          <button
            id="install-btn"
            onclick="installApp()"
            class="btn btn-sm btn-success rounded-pill ms-2"
            style="font-size: 12px"
          >
            ğŸ“² å®‰è£ App
          </button>
        </div>
        <p id="error-msg" class="text-danger text-center mt-3 small"></p>
      </div>
    </div>

    <!-- === èŠå¤©ç•«é¢ === -->
    <div id="chat-view">
      <!-- é ‚éƒ¨å°è¦½åˆ— -->
      <div
        class="bg-white p-3 shadow-sm d-flex justify-content-between align-items-center"
        style="height: 60px"
      >
        <!-- å·¦å´ï¼šæ¨™é¡Œèˆ‡äººæ•¸ (æ‰‹æ©Ÿç‰ˆå‚ç›´æ’åˆ—) -->
        <div class="d-flex flex-column justify-content-center">
          <div class="fw-bold fs-6">ğŸ’¬ ç§˜å¯†èŠå¤©å®¤</div>
          <div id="online-count" class="text-muted" style="font-size: 11px">
            (é€£ç·šä¸­...)
          </div>
        </div>

        <!-- å³å´ï¼šé€šçŸ¥æŒ‰éˆ•ã€ä½¿ç”¨è€…èˆ‡ç™»å‡º (æ°´å¹³æ’åˆ—) -->
        <div class="d-flex align-items-center">
          <button
            id="btn-notify"
            class="btn btn-sm btn-outline-light me-2 rounded-circle"
            style="
              width: 30px;
              height: 30px;
              padding: 0;
              display: flex;
              align-items: center;
              justify-content: center;
            "
            onclick="requestNotificationPermission()"
          >
            ğŸ””
          </button>
          <span
            id="user-badge"
            class="badge bg-light text-primary me-2 rounded-pill"
            style="font-size: 12px; padding: 5px 10px"
          ></span>
          <button
            class="btn btn-sm btn-light text-primary fw-bold rounded-pill"
            style="font-size: 12px; padding: 2px 8px"
            onclick="doLogout()"
          >
            ç™»å‡º
          </button>
        </div>
      </div>

      <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
      <div id="msg-container"></div>

      <!-- è²¼åœ–é¸å–® (é è¨­éš±è—) -->
      <div id="sticker-box" class="bg-light p-2 d-none border-top">
        <div class="d-flex gap-2 overflow-auto py-2">
          <!-- æ¸¬è©¦ç”¨è²¼åœ– GIF -->
          <img
            src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbXN6ZnB4eXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eXJ6eSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/LpDmM2wSt6kF2/giphy.gif"
            onclick="sendSticker(this.src)"
            class="sticker-btn"
            style="width: 80px; cursor: pointer; border-radius: 8px"
          />
          <img
            src="https://media.giphy.com/media/User2V1rL97i/giphy.gif"
            onclick="sendSticker(this.src)"
            class="sticker-btn"
            style="width: 80px; cursor: pointer; border-radius: 8px"
          />
          <img
            src="https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/giphy.gif"
            onclick="sendSticker(this.src)"
            class="sticker-btn"
            style="width: 80px; cursor: pointer; border-radius: 8px"
          />
          <img
            src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif"
            onclick="sendSticker(this.src)"
            class="sticker-btn"
            style="width: 80px; cursor: pointer; border-radius: 8px"
          />
        </div>
      </div>

      <!-- éš±è—çš„æª”æ¡ˆä¸Šå‚³ Input -->
      <input
        type="file"
        id="file-input"
        accept="image/*,video/*"
        style="display: none"
      />

      <!-- é€²åº¦æ¢ (é è¨­éš±è—) -->
      <div id="progress-container" class="px-3 py-1 d-none bg-white border-top">
        <div class="progress" style="height: 4px">
          <div
            id="progress-bar"
            class="progress-bar bg-success"
            role="progressbar"
            style="width: 0%"
          ></div>
        </div>
        <div
          id="progress-text"
          class="text-center text-muted mt-1"
          style="font-size: 10px"
        >
          æº–å‚™ä¸Šå‚³...
        </div>
      </div>

      <!-- åº•éƒ¨è¼¸å…¥å€ (å„ªåŒ–ç‰ˆ) -->
      <div class="input-area">
        <!-- ä¸Šå‚³æŒ‰éˆ• -->
        <button
          class="btn btn-light btn-circle border"
          onclick="triggerUpload()"
        >
          ğŸ“·
        </button>

        <!-- è²¼åœ–æŒ‰éˆ• (SVG åœ–ç¤º) -->
        <button
          class="btn btn-light text-secondary btn-circle"
          onclick="toggleSticker()"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
          </svg>
        </button>

        <!-- è¼¸å…¥æ¡† -->
        <input
          type="text"
          id="msg-input"
          class="form-control border-0 bg-light rounded-pill"
          placeholder="è¼¸å…¥è¨Šæ¯..."
        />

        <!-- å‚³é€æŒ‰éˆ• (SVG åœ–ç¤º) -->
        <button onclick="sendText()" class="btn btn-send btn-circle">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="white"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="margin-left: 2px; margin-top: 2px"
          >
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>

    <!-- === èªéŸ³é€šè©±ä»‹é¢ (æ‡¸æµ®è¦–çª—) === -->
    <div id="call-overlay" class="d-none">
      <div
        class="video-container"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
      >
        <div
          class="audio-only-placeholder"
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
          "
        >
          <div style="font-size: 4rem; margin-bottom: 20px">ğŸ¤</div>
          <div style="font-size: 1.5rem; font-weight: bold">èªéŸ³é€šè©±ä¸­</div>
        </div>
        <!-- éŸ³é‡æ¢ -->
        <div
          id="volume-meter-container"
          style="
            position: absolute;
            bottom: 80px;
            right: 10px;
            width: 80px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            z-index: 3;
          "
        >
          <div
            id="volume-bar"
            style="
              width: 0%;
              height: 100%;
              background: #0f0;
              border-radius: 3px;
              transition: width 0.1s;
            "
          ></div>
        </div>
      </div>
      <div id="call-status" class="mb-3 text-white">é€£ç·šä¸­...</div>
      <div class="call-controls">
        <button
          id="hangup-btn"
          class="btn btn-danger rounded-pill px-4"
          onclick="endCall()"
        >
          âŒ æ›æ–·
        </button>
      </div>
    </div>

    <!-- éš±è—çš„éŸ³è¨Šå…ƒç´ ç”¨æ–¼æ’­æ”¾å°æ–¹çš„è²éŸ³ -->
    <audio id="remote-audio" autoplay volume="1.0"></audio>

    <!-- ä¾†é›»é€šçŸ¥ Modal (ç°¡å–®ç‰ˆ) -->
    <div
      id="incoming-call-modal"
      class="modal"
      tabindex="-1"
      style="display: none; background: rgba(0, 0, 0, 0.5)"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ğŸ“ ä¾†é›»é€šçŸ¥</h5>
          </div>
          <div class="modal-body">
            <p id="caller-name">æœ‰äººæ‰“çµ¦ä½ ...</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="rejectCall()"
            >
              æ‹’çµ•
            </button>
            <button
              type="button"
              class="btn btn-success"
              onclick="acceptCall()"
            >
              æ¥è½
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è¼‰å…¥ Socket.io ç”¨æˆ¶ç«¯ç¨‹å¼ -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io(); // é€£ç·šï¼
      let myName = "";
      let lastDate = ""; // ç”¨ä¾†è¨˜éŒ„ä¸Šä¸€å‰‡è¨Šæ¯çš„æ—¥æœŸ

      // WebRTC è®Šæ•¸
      let isCaller = false;
      let localStream;
      let peerConnection;
      let candidateQueue = []; // ICE Candidate Queue
      let currentCallPartner = null; // è¨˜éŒ„ç›®å‰é€šè©±å°è±¡çš„ Socket ID
      const rtcConfig = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };

      // Debug: ç›£è½é€£ç·šç‹€æ…‹
      socket.on("connect", () => {
        console.log("âœ… Socket é€£ç·šæˆåŠŸï¼ID:", socket.id);
        const errorMsg = document.getElementById("error-msg");
        if (errorMsg) errorMsg.innerText = "";
      });

      socket.on("connect_error", (err) => {
        console.error("âŒ Socket é€£ç·šå¤±æ•—:", err);
        const errorMsg = document.getElementById("error-msg");
        if (errorMsg) errorMsg.innerText = "é€£ç·šå¤±æ•— (Socket): " + err.message;
      });

      socket.on("disconnect", () => {
        console.warn("âš ï¸ Socket æ–·ç·š");
      });

      // --- ç™»å…¥åŠŸèƒ½ ---
      // === æª¢æŸ¥æ˜¯å¦è¦è‡ªå‹•ç™»å…¥ ===
      // ç›´æ¥åŸ·è¡Œï¼Œä¸ç­‰å¾… onloadï¼Œç¢ºä¿æ‰‹æ©Ÿç‰ˆä¹Ÿèƒ½è®€åˆ°
      try {
        const savedAuth = localStorage.getItem("chat_auth");
        if (savedAuth) {
          const { username, password } = JSON.parse(savedAuth);
          const uInput = document.getElementById("username");
          const pInput = document.getElementById("password");
          const rInput = document.getElementById("remember-me");

          if (uInput) uInput.value = username;
          if (pInput) pInput.value = password;
          if (rInput) rInput.checked = true;
        }
      } catch (e) {
        console.error("Auto-fill error:", e);
      }

      // æª¢æŸ¥é€šçŸ¥æ¬Šé™ä¸¦æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      function updateNotifyBtn() {
        const btn = document.getElementById("btn-notify");
        if (!btn) return;
        if (Notification.permission === "granted") {
          btn.innerText = "ğŸ”•"; // å·²é–‹å•Ÿï¼Œé¡¯ç¤ºé—œé–‰(æˆ–åªæ˜¯ç‹€æ…‹)
          btn.title = "é€šçŸ¥å·²é–‹å•Ÿ";
          btn.classList.remove("btn-outline-light");
          btn.classList.add("btn-light", "text-primary");
        } else if (Notification.permission === "denied") {
          btn.innerText = "ğŸš«";
          btn.title = "é€šçŸ¥å·²å°é–";
        } else {
          btn.innerText = "ğŸ””";
          btn.title = "é–‹å•Ÿé€šçŸ¥";
        }
      }

      // è«‹æ±‚é€šçŸ¥æ¬Šé™
      function requestNotificationPermission() {
        if (!("Notification" in window)) {
          alert("é€™å€‹ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½ ğŸ˜­");
          return;
        }

        if (Notification.permission === "granted") {
          // å·²ç¶“é–‹å•Ÿï¼Œé€™è£¡å¯ä»¥åšã€Œæ¸¬è©¦é€šçŸ¥ã€
          new Notification("æ¸¬è©¦é€šçŸ¥", { body: "é€šçŸ¥åŠŸèƒ½æ­£å¸¸é‹ä½œä¸­ï¼" });
        } else {
          Notification.requestPermission().then((permission) => {
            updateNotifyBtn();
            if (permission === "granted") {
              new Notification("é€šçŸ¥å·²é–‹å•Ÿ", {
                body: "ä»¥å¾Œæœ‰æ–°è¨Šæ¯æœƒé€šçŸ¥ä½ å–”ï¼",
              });
            }
          });
        }
      }

      // ç™¼é€é€šçŸ¥
      function trySendNotification(data) {
        // å¦‚æœæ˜¯è‡ªå·±ç™¼çš„ï¼Œä¸é€šçŸ¥
        if (data.user === myName) return;
        // å¦‚æœæ²’æœ‰æ¬Šé™ï¼Œä¸é€šçŸ¥
        if (Notification.permission !== "granted") return;

        // åˆ¤æ–·å…§å®¹
        let bodyText = data.text;
        if (data.type === "sticker") bodyText = "å‚³é€äº†ä¸€å€‹è²¼åœ–";
        if (data.type === "image") bodyText = "å‚³é€äº†ä¸€å¼µåœ–ç‰‡";
        if (data.type === "video") bodyText = "å‚³é€äº†ä¸€éƒ¨å½±ç‰‡";

        // ç™¼é€
        const n = new Notification(data.user, {
          body: bodyText,
          icon: "/icon.png", // å‡è¨­æœ‰ icon
          tag: "chat-msg", // åŒä¸€å€‹ tag æœƒè¦†è“‹ï¼Œé¿å…å¤ªå¤šé€šçŸ¥
        });

        // é»æ“Šé€šçŸ¥æ‰“é–‹è¦–çª—
        n.onclick = function () {
          window.focus();
          n.close();
        };
      }

      // === æ–°å¢ï¼šåˆå§‹æ¬Šé™è«‹æ±‚ ===
      async function requestInitialPermissions() {
        try {
          let stream;
          try {
            // 1. å˜—è©¦å–å¾— è¦–è¨Š + éŸ³è¨Š
            stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true,
            });
          } catch (e) {
            if (
              e.name === "NotFoundError" ||
              e.name === "DevicesNotFoundError"
            ) {
              console.warn("æ‰¾ä¸åˆ°ç›¸æ©Ÿï¼Œå˜—è©¦åƒ…ç²å–éŸ³è¨Šæ¬Šé™...");
              // 2. å¦‚æœæ²’æœ‰ç›¸æ©Ÿï¼Œå˜—è©¦åƒ…éŸ³è¨Š
              stream = await navigator.mediaDevices.getUserMedia({
                audio: true,
              });
            } else {
              throw e; // å…¶ä»–éŒ¯èª¤ (å¦‚æ‹’çµ•æ¬Šé™) å¾€å¤–æ‹‹
            }
          }

          // 3. æª¢æŸ¥éº¥å…‹é¢¨æ˜¯å¦è¢«ç³»çµ±éœéŸ³
          const audioTracks = stream.getAudioTracks();
          if (audioTracks.length > 0 && audioTracks[0].muted) {
            alert(
              "âš ï¸ è­¦å‘Šï¼šåµæ¸¬åˆ°æ‚¨çš„éº¥å…‹é¢¨å·²è¢«ç³»çµ±éœéŸ³ï¼\nè«‹å‹™å¿…æª¢æŸ¥ Windows éŸ³æ•ˆè¨­å®šï¼Œå¦å‰‡å°æ–¹è½ä¸åˆ°æ‚¨çš„è²éŸ³ã€‚"
            );
          }

          // æˆåŠŸç²å–å¾Œç«‹å³é—œé–‰ï¼Œåªæ˜¯ç‚ºäº†è§¸ç™¼æˆæ¬Šæç¤º
          stream.getTracks().forEach((track) => track.stop());

          // éš±è— Modal
          document.getElementById("permission-modal").style.display = "none";

          // æª¢æŸ¥é€šçŸ¥æ¬Šé™ (é †ä¾¿)
          if (Notification.permission === "default") {
            Notification.requestPermission();
          }
        } catch (err) {
          console.error("Permission error:", err);
          if (
            err.name === "NotAllowedError" ||
            err.name === "PermissionDeniedError"
          ) {
            alert(
              "æ‚¨æ‹’çµ•äº†æ¬Šé™ï¼Œé€šè©±åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ ğŸ˜­\nè«‹é»æ“Šç¶²å€åˆ—å·¦å´çš„ã€Œé–é ­ã€åœ–ç¤ºä¾†é–‹å•Ÿæ¬Šé™ã€‚"
            );
          } else if (err.name === "NotFoundError") {
            alert("æ‰¾ä¸åˆ°éº¥å…‹é¢¨æˆ–ç›¸æ©Ÿ ğŸš«\nè«‹æª¢æŸ¥æ‚¨çš„è¨­å‚™é€£æ¥ã€‚");
          } else {
            alert(`ç™¼ç”ŸéŒ¯èª¤: ${err.name}\n${err.message}`);
          }
        }
      }

      // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ¬Šé™ç‹€æ…‹
      window.addEventListener("load", () => {
        updateNotifyBtn();

        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ¬Šé™ï¼Œå¦‚æœæ²’æœ‰ï¼Œé¡¯ç¤º Modal
        if (navigator.permissions && navigator.permissions.query) {
          navigator.permissions
            .query({ name: "microphone" })
            .then((permissionStatus) => {
              if (permissionStatus.state !== "granted") {
                document.getElementById("permission-modal").style.display =
                  "block";
                document
                  .getElementById("permission-modal")
                  .classList.add("show");
              }
            })
            .catch((err) => {
              console.log("Permission query failed", err);
            });
        }
      });

      function doLogin() {
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const rememberMe = document.getElementById("remember-me").checked;
        const errorMsg = document.getElementById("error-msg");

        if (!usernameInput || !passwordInput) {
          console.error("æ‰¾ä¸åˆ°è¼¸å…¥æ¡†å…ƒç´ ï¼");
          alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¼¸å…¥æ¡†");
          return;
        }

        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !password) {
          errorMsg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼";
          return;
        }

        // Debug: æª¢æŸ¥ Socket é€£ç·šç‹€æ…‹
        if (!socket.connected) {
          alert(
            "âš ï¸ å°šæœªé€£ç·šåˆ°ä¼ºæœå™¨ï¼\nè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡æ–°æ•´ç†é é¢ã€‚\nSocket ID: " +
              socket.id
          );
          return;
        }

        // å„²å­˜/æ¸…é™¤ å¸³å¯†
        if (rememberMe) {
          localStorage.setItem(
            "chat_auth",
            JSON.stringify({ username, password })
          );
        } else {
          localStorage.removeItem("chat_auth");
        }

        // å˜—è©¦ç™»å…¥
        socket.emit("try_login", { username, password });

        // ç›£è½ç™»å…¥çµæœ (åªç›£è½ä¸€æ¬¡ï¼Œé¿å…é‡è¤‡ç¶å®š)
        socket.once("login_result", (data) => {
          if (data.success) {
            myName = data.username;
            document.getElementById("login-view").style.display = "none";
            document.getElementById("chat-view").style.display = "flex";
            document.getElementById("user-badge").innerText = myName;

            // æ¸²æŸ“æ­·å²è¨Šæ¯
            renderHistory(data.history);

            // è¨»å†Š Web Push
            registerPush();
          } else {
            document.getElementById("error-msg").innerText = data.msg;
          }
        });
      }

      function doLogout() {
        localStorage.removeItem("chat_auth");
        location.reload();
      }

      function renderHistory(history) {
        if (history && history.length > 0) {
          history.forEach((msg) => {
            renderMessage(msg);
          });
        }
      }

      function sendText() {
        const input = document.getElementById("msg-input");
        const txt = input.value.trim();
        if (txt) {
          socket.emit("send_msg", { text: txt, type: "text" });
          input.value = "";
        }
      }

      function sendSticker(url) {
        socket.emit("send_msg", { text: url, type: "sticker" });
        toggleSticker(); // é—œé–‰é¸å–®
      }

      function toggleSticker() {
        const box = document.getElementById("sticker-box");
        box.classList.toggle("d-none");
      }

      // ç›£è½æ”¶åˆ°è¨Šæ¯ (é€™è£¡å°±æ˜¯æˆ‘å€‘æ”¹å¯«é‚è¼¯çš„åœ°æ–¹)
      socket.on("receive_msg", (data) => {
        renderMessage(data);
        trySendNotification(data); // å˜—è©¦ç™¼é€é€šçŸ¥
      });

      // ç¨ç«‹å‡ºä¾†çš„æ¸²æŸ“å‡½å¼
      function renderMessage(data) {
        const container = document.getElementById("msg-container");

        // 0. æª¢æŸ¥æ—¥æœŸï¼Œæ˜¯å¦éœ€è¦æ’å…¥åˆ†éš”ç·š
        // data.timestamp æ ¼å¼: "2023-10-27T10:00:00.000Z"
        if (data.timestamp) {
          const dateObj = new Date(data.timestamp);
          const dateStr = dateObj.toLocaleDateString("zh-TW"); // e.g. "2023/10/27"

          if (dateStr !== lastDate) {
            const divider = document.createElement("div");
            divider.className = "date-divider";
            divider.innerHTML = `<span>${dateStr}</span>`;
            container.appendChild(divider);
            lastDate = dateStr;
          }
        }

        // 1. å¦‚æœæ˜¯ç³»çµ±è¨Šæ¯ï¼Œç›´æ¥é¡¯ç¤ºä¸¦çµæŸ
        if (data.type === "system") {
          const div = document.createElement("div");
          div.className = "system-notice";
          div.innerText = data.text;
          container.appendChild(div);
          container.scrollTop = container.scrollHeight;
          return;
        }

        // 2. å»ºç«‹æœ€å¤–å±¤çš„åˆ—
        const msgRow = document.createElement("div");
        const isMe = data.user === myName;

        // è¨­å®šæ˜¯èª°ç™¼çš„ (æ±ºå®šé å·¦é‚„æ˜¯é å³)
        msgRow.className = `msg-row ${isMe ? "me" : "other"}`;

        // 2.5 å¦‚æœæ˜¯åˆ¥äººçš„è¨Šæ¯ï¼Œä¸”æˆ‘æœ‰ IDï¼Œå°±æ¨™è¨˜å·²è®€
        if (!isMe && data.id) {
          socket.emit("mark_read", { messageId: data.id, user: myName });
        }

        // 2.6 æº–å‚™å·²è®€ HTML (åªæœ‰è‡ªå·±çš„è¨Šæ¯æ‰é¡¯ç¤º)
        let readHtml = "";
        if (isMe && data.readBy && data.readBy.length > 0) {
          // ç°¡å–®åˆ¤æ–·ï¼šåªè¦æœ‰äººè®€éå°±é¡¯ç¤ºå·²è®€
          // éæ¿¾æ‰è‡ªå·± (ç†è«–ä¸Š server æ‡‰è©²è™•ç†ï¼Œä½†å‰ç«¯é˜²å‘†)
          const readers = data.readBy.filter((u) => u !== myName);
          if (readers.length > 0) {
            readHtml = `<div class="read-status">å·²è®€</div>`;
          }
        }

        // 3. æº–å‚™å…§å®¹ HTML
        // å¦‚æœæ˜¯å°æ–¹ï¼Œæ‰é¡¯ç¤ºåå­—
        const nameHtml = isMe ? "" : `<div class="msg-name">${data.user}</div>`;

        // åˆ¤æ–·æ˜¯æ–‡å­—é‚„æ˜¯è²¼åœ–
        let contentHtml = "";
        if (data.type === "sticker") {
          contentHtml = `<img src="${data.text}" class="sticker-img">`;
        } else if (data.type === "image") {
          contentHtml = `<img src="${data.text}" class="msg-img" onclick="window.open('${data.text}')">`;
        } else if (data.type === "video") {
          contentHtml = `<video src="${data.text}" class="msg-video" controls></video>`;
        } else {
          contentHtml = data.text;
        }

        // 4. çµ„åˆ HTML (é—œéµçµæ§‹è®ŠåŒ–)
        // çµæ§‹è®Šæˆäº†ï¼š[åå­—] (å°æ–¹) -> [å¤–åŒ…è£ flex: æ°£æ³¡ + æ™‚é–“]
        // æ™‚é–“å€å¡ŠåŠ å…¥å·²è®€ç‹€æ…‹
        msgRow.innerHTML = `
                ${nameHtml}
                <div class="bubble-wrapper">
                    <div class="bubble" data-id="${
                      data.id || ""
                    }">${contentHtml}</div>
                    <div class="msg-time">
                        ${readHtml}
                        <span>${data.time}</span>
                    </div>
                </div>
            `;

        container.appendChild(msgRow);
        container.scrollTop = container.scrollHeight; // è‡ªå‹•æ²åˆ°åº•éƒ¨
      }

      // ç›£è½å·²è®€æ›´æ–°
      socket.on("message_read", (data) => {
        const { messageId, readBy } = data;
        // æ‰¾åˆ°å°æ‡‰çš„è¨Šæ¯æ°£æ³¡
        const bubble = document.querySelector(
          `.bubble[data-id="${messageId}"]`
        );
        if (bubble) {
          // å¾€ä¸Šæ‰¾ wrapper å†æ‰¾ time å€å¡Š
          const wrapper = bubble.parentElement;
          const timeDiv = wrapper.querySelector(".msg-time");
          if (timeDiv) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰å·²è®€æ¨™ç±¤
            if (!timeDiv.querySelector(".read-status")) {
              // æ’å…¥å·²è®€æ¨™ç±¤åˆ°æœ€å‰é¢
              const readSpan = document.createElement("div");
              readSpan.className = "read-status";
              readSpan.innerText = "å·²è®€";
              timeDiv.prepend(readSpan);
            }
          }
        }
      });

      // ç³»çµ±è¨Šæ¯ (èˆŠçš„ç›£è½å™¨ï¼Œå¦‚æœ server ä¸å†é€ system_msg å¯ä»¥ç§»é™¤ï¼Œé€™è£¡ä¿ç•™ç›¸å®¹æ€§)
      socket.on("system_msg", (txt) => {
        const container = document.getElementById("msg-container");
        const div = document.createElement("div");
        div.className = "system-notice";
        div.innerText = txt;
        container.appendChild(div);
      });

      // ç›£è½å¼·åˆ¶ç™»å‡º
      socket.on("force_logout", () => {
        alert("é€£ç·šå·²æ–·é–‹ï¼Œè«‹é‡æ–°ç™»å…¥ï¼ ğŸ”Œ");
        location.reload();
      });

      // ç·šä¸Šäººæ•¸æ›´æ–° (æ”¹ç‚ºé¡¯ç¤ºåå–®)
      socket.on("online_users_update", (users) => {
        const el = document.getElementById("online-count");
        if (el) {
          el.innerHTML = ""; // Clear
          const countSpan = document.createElement("span");
          countSpan.innerText = `(${users.length}äºº): `;
          el.appendChild(countSpan);

          users.forEach((u) => {
            const span = document.createElement("span");
            span.className = "me-1";
            // ä½¿ç”¨ socket.id ä¾†åˆ¤æ–·æ˜¯ä¸æ˜¯è‡ªå·±
            const isMe = (u.id && u.id === socket.id) || u.name === myName;

            if (isMe) {
              span.innerText = u.name || u;
            } else {
              if (u.id) {
                span.innerHTML = `<a href="#" onclick="startCall('${u.id}'); return false;" style="text-decoration: none;">${u.name} ğŸ“</a>`;
              } else {
                span.innerText = u.name || u;
              }
            }
            el.appendChild(span);
            el.appendChild(document.createTextNode(" "));
          });
        }
      });

      // ç›£è½å°æ–¹æ›æ–·é€šè©±
      socket.on("call-ended", () => {
        log("å°æ–¹å·²æ›æ–·é€šè©±");
        alert("ğŸ“ å°æ–¹å·²æ›æ–·é€šè©±");
        endCall();
      });

      // === çµ±ä¸€çš„åª’é«”ç²å–å‡½å¼ (å« fallback & é è¨­é—œé–‰è¦–è¨Š) ===
      // === éŸ³è¨Šåˆ†æ (éŸ³é‡æ¢) ===
      let audioContext;
      let analyser;
      let microphone;
      let javascriptNode;

      function setupAudioAnalysis(stream) {
        try {
          if (!audioContext) {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          }
          if (audioContext.state === "suspended") {
            audioContext.resume();
          }

          microphone = audioContext.createMediaStreamSource(stream);
          analyser = audioContext.createAnalyser();
          analyser.smoothingTimeConstant = 0.8;
          analyser.fftSize = 1024;

          javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

          microphone.connect(analyser);
          analyser.connect(javascriptNode);
          javascriptNode.connect(audioContext.destination);

          javascriptNode.onaudioprocess = function () {
            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array);
            let values = 0;
            const length = array.length;
            for (let i = 0; i < length; i++) {
              values += array[i];
            }
            const average = values / length;

            // æ›´æ–° UI
            const volumeBar = document.getElementById("volume-bar");
            if (volumeBar) {
              // æ”¾å¤§ä¸€é»æ•ˆæœ
              let percent = Math.min(100, average * 2);
              volumeBar.style.width = percent + "%";

              // é¡è‰²è®ŠåŒ–
              if (percent > 50) volumeBar.style.background = "#ff0"; // é»ƒè‰²
              if (percent > 80) volumeBar.style.background = "#f00"; // ç´…è‰²
              else volumeBar.style.background = "#0f0"; // ç¶ è‰²
            }
          };
        } catch (e) {
          console.error("Audio analysis setup failed:", e);
        }
      }

      // è§£æ±ºæ‰‹æ©Ÿç€è¦½å™¨ AudioContext éœ€è¦ä½¿ç”¨è€…äº’å‹•æ‰èƒ½å•Ÿå‹•çš„å•é¡Œ
      document.addEventListener("click", function () {
        if (audioContext && audioContext.state === "suspended") {
          audioContext.resume().then(() => {
            console.log("AudioContext resumed by user gesture");
          });
        }
      });

      async function getLocalStream() {
        try {
          // åªç²å–éŸ³è¨Šï¼ˆç´”èªéŸ³é€šè©±ï¼‰
          console.log("å˜—è©¦ç²å–éŸ³è¨Š...");
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          console.log("æˆåŠŸç²å–éŸ³è¨Šï¼");
          console.log("éŸ³è¨Šè»Œé“:", stream.getAudioTracks().length);

          stream.getAudioTracks().forEach((track) => {
            console.log(
              "å•Ÿç”¨éŸ³è¨Šè»Œé“:",
              track.id,
              "enabled=",
              track.enabled,
              "muted=",
              track.muted
            );
            track.enabled = true;

            // æª¢æŸ¥è»Œé“æ˜¯å¦è¢«éœéŸ³
            if (track.muted) {
              console.warn(
                "âš ï¸ è­¦å‘Šï¼šéŸ³è¨Šè»Œé“è¢«éœéŸ³ï¼é€™å¯èƒ½æ˜¯ç³»çµ±æˆ–ç€è¦½å™¨è¨­å®šçš„å•é¡Œã€‚"
              );
              alert(
                "âš ï¸ æ‚¨çš„éº¥å…‹é¢¨ä¼¼ä¹è¢«éœéŸ³äº†ï¼\n\nè«‹æª¢æŸ¥ï¼š\n1. ç€è¦½å™¨çš„éº¥å…‹é¢¨æ¬Šé™\n2. ç³»çµ±çš„éº¥å…‹é¢¨è¨­å®š\n3. æ˜¯å¦æœ‰å…¶ä»–æ‡‰ç”¨ç¨‹å¼æ­£åœ¨ä½¿ç”¨éº¥å…‹é¢¨"
              );
            }
          });
          return stream;
        } catch (err) {
          console.warn("ç„¡æ³•å–å¾—å½±éŸ³ï¼Œå˜—è©¦åƒ…éŸ³è¨Š...", err.name, err.message);

          // å¦‚æœæ˜¯æ‰¾ä¸åˆ°è¨­å‚™ (NotFoundError) æˆ– è¨­å‚™ç„¡æ³•ä½¿ç”¨ (NotReadableError)
          // å˜—è©¦åªæŠ“éº¥å…‹é¢¨
          if (
            err.name === "NotFoundError" ||
            err.name === "DevicesNotFoundError" ||
            err.name === "NotReadableError"
          ) {
            try {
              console.log("å˜—è©¦åƒ…ç²å–éŸ³è¨Š...");
              const stream = await navigator.mediaDevices.getUserMedia({
                video: false,
                audio: true,
              });
              console.log(
                "æˆåŠŸç²å–éŸ³è¨Šï¼éŸ³è¨Šè»Œé“:",
                stream.getAudioTracks().length
              );
              return stream;
            } catch (err2) {
              console.error("éº¥å…‹é¢¨ä¹Ÿç„¡æ³•ç²å–:", err2.name, err2.message);
              throw err2;
            }
          }
          throw err;
        }
      }

      // åˆ‡æ›è¦–è¨Šé–‹é—œ
      function toggleVideo() {
        if (!localStream) return;
        const videoTrack = localStream.getVideoTracks()[0];
        const placeholder = document.getElementById("audio-only-placeholder");

        if (videoTrack) {
          videoTrack.enabled = !videoTrack.enabled;
          const btn = document.getElementById("btn-toggle-video");
          if (videoTrack.enabled) {
            btn.classList.remove("btn-secondary");
            btn.classList.add("btn-primary");
            btn.innerText = "ğŸ“¹ è¦–è¨Šå·²é–‹";
            if (placeholder) placeholder.classList.add("d-none");
          } else {
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-secondary");
            btn.innerText = "ğŸ“· é–‹å•Ÿè¦–è¨Š";
            if (placeholder) placeholder.classList.remove("d-none");
          }
        } else {
          alert("æ‰¾ä¸åˆ°é¡é ­ï¼Œç„¡æ³•é–‹å•Ÿè¦–è¨Š ğŸ˜…");
        }
      }

      // 1. ç™¼èµ·é€šè©±
      async function startCall(socketId) {
        log("é–‹å§‹å‘¼å«: " + socketId);
        isCaller = true;
        currentCallPartner = socketId; // è¨˜éŒ„é€šè©±å°è±¡
        document.getElementById("call-overlay").classList.remove("d-none");
        document.getElementById("call-status").innerText = "æ­£åœ¨å‘¼å«...";

        try {
          // æ”¹ç”¨å°è£å¥½çš„å‡½å¼
          localStream = await getLocalStream();
          log("å–å¾—æœ¬åœ°ä¸²æµæˆåŠŸ");

          // å•Ÿå‹•éŸ³é‡ç›£æ¸¬
          setupAudioAnalysis(localStream);

          peerConnection = new RTCPeerConnection(rtcConfig);
          log("å»ºç«‹ PeerConnection æˆåŠŸ");

          // ç›£è½é€£ç·šç‹€æ…‹æ”¹è®Š
          peerConnection.oniceconnectionstatechange = () => {
            console.log("ICE State:", peerConnection.iceConnectionState);
            log("ICE State: " + peerConnection.iceConnectionState);
            if (
              peerConnection.iceConnectionState === "connected" ||
              peerConnection.iceConnectionState === "completed"
            ) {
              document.getElementById("call-status").innerText = "é€šè©±ä¸­ ğŸŸ¢";
            } else if (
              peerConnection.iceConnectionState === "disconnected" ||
              peerConnection.iceConnectionState === "failed"
            ) {
              document.getElementById("call-status").innerText = "é€£ç·šä¸­æ–· ğŸ”´";
            }
          };

          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              log("é€å‡º ICE Candidate");
              socket.emit("ice-candidate", {
                to: socketId,
                candidate: event.candidate,
              });
            }
          };
          peerConnection.ontrack = (event) => {
            log("æ”¶åˆ°é ç«¯ä¸²æµ");
            const remoteAudio = document.getElementById("remote-audio");

            if (!remoteAudio) {
              console.error("æ‰¾ä¸åˆ° remote-audio å…ƒç´ ï¼");
              alert("âš ï¸ éŸ³è¨Šæ’­æ”¾å…ƒç´ è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ï¼");
              return;
            }

            remoteAudio.srcObject = event.streams[0];

            // ç¢ºä¿éŸ³è¨Šæ’­æ”¾
            remoteAudio.muted = false; // å¼·åˆ¶é–‹å•Ÿè²éŸ³
            remoteAudio.volume = 1.0;
            remoteAudio.play().catch((e) => {
              log("æ’­æ”¾å¤±æ•—: " + e.message);
              alert("ç€è¦½å™¨é˜»æ“‹äº†è‡ªå‹•æ’­æ”¾ï¼Œè«‹é»æ“Šç•«é¢ä»»æ„è™•ä¾†é–‹å•Ÿè²éŸ³ï¼");
            });

            // æª¢æŸ¥éŸ³è¨Šè»Œé“
            const audioTracks = event.streams[0].getAudioTracks();
            log(`éŸ³è¨Šè»Œé“æ•¸é‡: ${audioTracks.length}`);
            audioTracks.forEach((track, i) => {
              log(
                `éŸ³è¨Šè»Œ ${i}: enabled=${track.enabled}, muted=${track.muted}`
              );
              if (track.muted) {
                log(`è­¦å‘Š: éŸ³è¨Šè»Œ ${i} åˆå§‹ç‹€æ…‹ç‚º mutedï¼Œç­‰å¾… 3 ç§’æª¢æŸ¥...`);
                setTimeout(() => {
                  if (track.muted) {
                    alert(
                      "âš ï¸ åš´é‡è­¦å‘Šï¼šæ‚¨çš„éº¥å…‹é¢¨æŒçºŒè¢«éœéŸ³ï¼\n\n1. è«‹æª¢æŸ¥éº¥å…‹é¢¨æ˜¯å¦æœ‰ã€Œå¯¦é«”éœéŸ³æŒ‰éˆ•ã€ã€‚\n2. è«‹ç¢ºèª Windows è¨­å®š > éš±ç§æ¬Š > éº¥å…‹é¢¨å­˜å–æ¬Šé™æ˜¯å¦é–‹å•Ÿã€‚"
                    );
                    document.getElementById("call-status").innerText =
                      "âš ï¸ éº¥å…‹é¢¨ç„¡è¨Šè™Ÿ";
                    document.getElementById("call-status").style.color = "red";
                  }
                }, 3000);
              }
            });

            // å¼·åˆ¶æ›´æ–°ç‹€æ…‹
            document.getElementById("call-status").innerText = "é€šè©±ä¸­ ğŸŸ¢";
          };
          localStream
            .getTracks()
            .forEach((track) => peerConnection.addTrack(track, localStream));

          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          log("é€å‡º Offer");

          socket.emit("call-user", {
            userToCall: socketId,
            signalData: offer,
            from: myName,
          });
        } catch (err) {
          console.error("ç„¡æ³•å–å¾—é¡é ­/éº¥å…‹é¢¨", err);
          log("Error: " + err.message);
          alert(
            `ç„¡æ³•å–å¾—é¡é ­/éº¥å…‹é¢¨æ¬Šé™ ğŸ˜­\néŒ¯èª¤ä»£ç¢¼: ${err.name}\nè¨Šæ¯: ${err.message}`
          );
          endCall();
        }
      }

      // 2. æ”¶åˆ°ä¾†é›»
      let incomingCallData = null;
      socket.on("call-made", async (data) => {
        log("æ”¶åˆ°ä¾†é›»: " + data.name);
        incomingCallData = data;
        document.getElementById(
          "caller-name"
        ).innerText = `${data.name} æ‰“çµ¦ä½ ...`;
        document.getElementById("incoming-call-modal").style.display = "block";
        document.getElementById("incoming-call-modal").classList.add("show");
      });

      // 3. æ¥è½
      async function acceptCall() {
        log("æ¥è½é›»è©±");
        currentCallPartner = incomingCallData.socket; // è¨˜éŒ„é€šè©±å°è±¡
        document.getElementById("incoming-call-modal").style.display = "none";
        document.getElementById("incoming-call-modal").classList.remove("show");
        document.getElementById("call-overlay").classList.remove("d-none");
        document.getElementById("call-status").innerText = "é€£ç·šä¸­...";

        try {
          // æ”¹ç”¨å°è£å¥½çš„å‡½å¼
          localStream = await getLocalStream();
          log("å–å¾—æœ¬åœ°ä¸²æµæˆåŠŸ");

          peerConnection = new RTCPeerConnection(rtcConfig);
          log("å»ºç«‹ PeerConnection æˆåŠŸ");

          // ç›£è½é€£ç·šç‹€æ…‹æ”¹è®Š
          peerConnection.oniceconnectionstatechange = () => {
            console.log("ICE State:", peerConnection.iceConnectionState);
            log("ICE State: " + peerConnection.iceConnectionState);
            if (
              peerConnection.iceConnectionState === "connected" ||
              peerConnection.iceConnectionState === "completed"
            ) {
              document.getElementById("call-status").innerText = "é€šè©±ä¸­ ğŸŸ¢";
            } else if (
              peerConnection.iceConnectionState === "disconnected" ||
              peerConnection.iceConnectionState === "failed"
            ) {
              document.getElementById("call-status").innerText = "é€£ç·šä¸­æ–· ğŸ”´";
            }
          };

          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              log("é€å‡º ICE Candidate");
              socket.emit("ice-candidate", {
                to: incomingCallData.socket,
                candidate: event.candidate,
              });
            }
          };
          peerConnection.ontrack = (event) => {
            log("æ”¶åˆ°é ç«¯ä¸²æµ");
            const remoteVideo = document.getElementById("remote-video");
            remoteVideo.srcObject = event.streams[0];

            // ç¢ºä¿éŸ³è¨Šæ’­æ”¾
            remoteVideo.muted = false; // å¼·åˆ¶é–‹å•Ÿè²éŸ³
            remoteVideo.volume = 1.0;
            remoteVideo.play().catch((e) => {
              log("æ’­æ”¾å¤±æ•—: " + e.message);
              alert("ç€è¦½å™¨é˜»æ“‹äº†è‡ªå‹•æ’­æ”¾ï¼Œè«‹é»æ“Šç•«é¢ä»»æ„è™•ä¾†é–‹å•Ÿè²éŸ³ï¼");
            });

            // æª¢æŸ¥éŸ³è¨Šè»Œé“
            const audioTracks = event.streams[0].getAudioTracks();
            log(`éŸ³è¨Šè»Œé“æ•¸é‡: ${audioTracks.length}`);
            audioTracks.forEach((track, i) => {
              log(
                `éŸ³è¨Šè»Œ ${i}: enabled=${track.enabled}, muted=${track.muted}`
              );
              if (track.muted) {
                log(`è­¦å‘Š: éŸ³è¨Šè»Œ ${i} åˆå§‹ç‹€æ…‹ç‚º mutedï¼Œç­‰å¾… 3 ç§’æª¢æŸ¥...`);
                setTimeout(() => {
                  if (track.muted) {
                    alert(
                      "âš ï¸ åš´é‡è­¦å‘Šï¼šæ‚¨çš„éº¥å…‹é¢¨æŒçºŒè¢«éœéŸ³ï¼\n\n1. è«‹æª¢æŸ¥éº¥å…‹é¢¨æ˜¯å¦æœ‰ã€Œå¯¦é«”éœéŸ³æŒ‰éˆ•ã€ã€‚\n2. è«‹ç¢ºèª Windows è¨­å®š > éš±ç§æ¬Š > éº¥å…‹é¢¨å­˜å–æ¬Šé™æ˜¯å¦é–‹å•Ÿã€‚"
                    );
                    document.getElementById("call-status").innerText =
                      "âš ï¸ éº¥å…‹é¢¨ç„¡è¨Šè™Ÿ";
                    document.getElementById("call-status").style.color = "red";
                  }
                }, 3000);
              }
            });

            // å¼·åˆ¶æ›´æ–°ç‹€æ…‹
            document.getElementById("call-status").innerText = "é€šè©±ä¸­ ğŸŸ¢";
          };
          localStream
            .getTracks()
            .forEach((track) => peerConnection.addTrack(track, localStream));

          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(incomingCallData.offer)
          );
          processCandidateQueue(); // Process queued candidates
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          log("é€å‡º Answer");

          socket.emit("make-answer", {
            to: incomingCallData.socket,
            signal: answer,
          });
        } catch (err) {
          console.error("ç„¡æ³•å–å¾—é¡é ­/éº¥å…‹é¢¨", err);
          log("Error: " + err.message);
          alert(
            `ç„¡æ³•å–å¾—é¡é ­/éº¥å…‹é¢¨æ¬Šé™ ğŸ˜­\néŒ¯èª¤ä»£ç¢¼: ${err.name}\nè¨Šæ¯: ${err.message}`
          );
          endCall();
        }
      }

      function rejectCall() {
        document.getElementById("incoming-call-modal").style.display = "none";
        document.getElementById("incoming-call-modal").classList.remove("show");
        // å¯ä»¥ç™¼é€æ‹’çµ•äº‹ä»¶çµ¦å°æ–¹ (ç›®å‰å…ˆçœç•¥)
      }

      // 4. å°æ–¹å·²æ¥è½ (ç™¼èµ·è€…æ”¶åˆ° Answer)
      socket.on("answer-made", async (data) => {
        await peerConnection.setRemoteDescription(
          new RTCSessionDescription(data.answer)
        );
        processCandidateQueue(); // Process queued candidates
        // document.getElementById("call-status").innerText = "é€šè©±ä¸­";
      });

      // === Debug Log ===
      function log(msg) {
        console.log(msg);
        const el = document.getElementById("debug-log");
        if (el) {
          const div = document.createElement("div");
          div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
          el.appendChild(div);
          el.scrollTop = el.scrollHeight;
        }
      }

      // 5. æ”¶åˆ° ICE å€™é¸äºº
      socket.on("ice-candidate", async (data) => {
        try {
          if (peerConnection && peerConnection.remoteDescription) {
            log("æ”¶åˆ° ICE Candidate");
            await peerConnection.addIceCandidate(
              new RTCIceCandidate(data.candidate)
            );
          } else {
            log("æš«å­˜ ICE Candidate (é€£ç·šæœªå°±ç·’)");
            candidateQueue.push(data.candidate);
          }
        } catch (e) {
          // å¿½ç•¥ OperationError (é€šå¸¸æ˜¯å› ç‚ºé€£ç·šå”å•†æœªå®Œæˆæˆ–å–®æ–¹ç„¡è¦–è¨Š)
          if (e.name !== "OperationError") {
            console.error("Error adding received ice candidate", e);
            log("Error adding ICE: " + e.message);
          }
        }
      });

      // Process queued ICE candidates
      async function processCandidateQueue() {
        if (candidateQueue.length > 0) {
          log(`è™•ç†æš«å­˜çš„ ${candidateQueue.length} å€‹ ICE Candidates`);
          for (const candidate of candidateQueue) {
            try {
              await peerConnection.addIceCandidate(
                new RTCIceCandidate(candidate)
              );
            } catch (e) {
              console.error("Error adding queued ice candidate", e);
            }
          }
          candidateQueue = [];
        }
      }

      // 6. æ›æ–·
      function endCall() {
        // é€šçŸ¥å°æ–¹æ›æ–·
        socket.emit("call-ended", { to: currentCallPartner });

        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }
        document.getElementById("call-overlay").classList.add("d-none");
        currentCallPartner = null; // æ¸…é™¤é€šè©±å°è±¡
        // é‡æ–°æ•´ç†é é¢æœ€ç°¡å–®ï¼Œç¢ºä¿ç‹€æ…‹æ¸…ç©º (æˆ–ç™¼é€æ›æ–·äº‹ä»¶)
        // location.reload();
      }

      // æŒ‰ Enter ç™¼é€
      document.getElementById("msg-input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendText();
      });

      // è§¸ç™¼æª”æ¡ˆä¸Šå‚³
      function triggerUpload() {
        document.getElementById("file-input").click();
      }

      // ç›£è½æª”æ¡ˆé¸æ“‡
      document
        .getElementById("file-input")
        .addEventListener("change", function () {
          const file = this.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);

          // é¡¯ç¤ºé€²åº¦æ¢
          const pContainer = document.getElementById("progress-container");
          const pBar = document.getElementById("progress-bar");
          const pText = document.getElementById("progress-text");

          pContainer.classList.remove("d-none");
          pBar.style.width = "0%";
          pText.innerText = "é–‹å§‹ä¸Šå‚³...";

          // æ”¹ç”¨ XHR ä»¥ç›£è½é€²åº¦
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/upload", true);

          // ç›£è½ä¸Šå‚³é€²åº¦
          xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              pBar.style.width = percent + "%";
              pText.innerText = `ä¸Šå‚³ä¸­... ${percent}%`;
            }
          };

          // ä¸Šå‚³å®Œæˆ
          xhr.onload = function () {
            if (xhr.status === 200) {
              const url = xhr.responseText;
              // ä¸Šå‚³æˆåŠŸï¼Œç™¼é€è¨Šæ¯
              const type = file.type.startsWith("image/") ? "image" : "video";
              socket.emit("send_msg", {
                text: url,
                type: type,
              });
              pText.innerText = "ä¸Šå‚³å®Œæˆï¼ âœ…";
              setTimeout(() => {
                pContainer.classList.add("d-none");
              }, 1000);
            } else {
              console.error("ä¸Šå‚³å¤±æ•—");
              pText.innerText = "ä¸Šå‚³å¤±æ•— âŒ";
              alert("ä¸Šå‚³å¤±æ•— ğŸ˜­");
              setTimeout(() => {
                pContainer.classList.add("d-none");
              }, 2000);
            }
          };

          xhr.onerror = function () {
            console.error("ä¸Šå‚³éŒ¯èª¤");
            pText.innerText = "ç¶²è·¯éŒ¯èª¤ âŒ";
            alert("ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤ ğŸ˜­");
            setTimeout(() => {
              pContainer.classList.add("d-none");
            }, 2000);
          };

          xhr.send(formData);

          // æ¸…ç©º inputï¼Œé€™æ¨£æ‰èƒ½é‡è¤‡é¸åŒä¸€å€‹æª”æ¡ˆ
          this.value = "";
        });

      // è¨»å†Š Service Worker (PWA)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/sw.js")
          .then(() => console.log("Service Worker Registered"))
          .catch((err) => console.log("Service Worker Failed", err));
      }

      // === é™¤éŒ¯åŠŸèƒ½ï¼šæª¢æŸ¥ HTTPS ===
      window.addEventListener("load", () => {
        const isLocalhost =
          location.hostname === "localhost" ||
          location.hostname === "127.0.0.1";
        const isHttps = location.protocol === "https:";

        if (!isLocalhost && !isHttps) {
          alert(
            "âš ï¸ æ³¨æ„ï¼šè¦–è¨Šé€šè©±åŠŸèƒ½å¿…é ˆä½¿ç”¨ HTTPS é€£ç·šï¼\nè«‹å°‡ç¶²å€é–‹é ­çš„ http:// æ”¹ç‚º https://"
          );
        }
      });

      // === Web Push Notification Logic ===
      const publicVapidKey =
        "BHUAd0UBrw_gU3Xq7z8xr2IarA3HGq-8yy0rqJw78e7b6inpc3owZSb_Y9C_AieNPMf13fYJCeizUOSw5A5tj4g";

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, "+")
          .replace(/_/g, "/");

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      async function registerPush() {
        if ("serviceWorker" in navigator) {
          try {
            const registration = await navigator.serviceWorker.ready;

            // è¨‚é–± Push
            const subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(publicVapidKey),
            });

            console.log("Push Subscribed:", subscription);

            // å‚³é€è¨‚é–±è³‡è¨Šçµ¦ Server
            await fetch("/subscribe?username=" + myName, {
              method: "POST",
              body: JSON.stringify(subscription),
              headers: {
                "content-type": "application/json",
              },
            });
            console.log("Push Sent to Server");
          } catch (err) {
            console.error("Push Registration Failed", err);
          }
        }
      }

      // === Notification Toggle Logic ===
      let notificationsEnabled =
        localStorage.getItem("notificationsEnabled") !== "false"; // é è¨­é–‹å•Ÿ

      async function requestNotificationPermission() {
        if (!("Notification" in window)) {
          alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½ ğŸ˜¢");
          return;
        }

        // å¦‚æœç€è¦½å™¨æ¬Šé™é‚„æ²’å…è¨±ï¼Œå…ˆè«‹æ±‚æ¬Šé™
        if (Notification.permission === "default") {
          try {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
              notificationsEnabled = true;
              localStorage.setItem("notificationsEnabled", "true");
              alert("âœ… é€šçŸ¥æ¬Šé™å·²é–‹å•Ÿï¼\næ‚¨å°‡æœƒæ”¶åˆ°æ–°è¨Šæ¯çš„é€šçŸ¥");
              updateNotifyBtn();
              // å¦‚æœå·²ç™»å…¥ï¼Œè¨»å†Š Push
              if (myName) {
                registerPush();
              }
            } else {
              alert("âŒ é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•\næ‚¨å°‡ç„¡æ³•æ”¶åˆ°æ–°è¨Šæ¯é€šçŸ¥");
              updateNotifyBtn();
            }
          } catch (err) {
            console.error("Notification permission error:", err);
            alert("é€šçŸ¥æ¬Šé™è«‹æ±‚å¤±æ•—ï¼š" + err.message);
          }
          return;
        }

        // å¦‚æœæ¬Šé™å·²ç¶“å…è¨±ï¼Œåˆ‡æ›é–‹é—œç‹€æ…‹
        if (Notification.permission === "granted") {
          notificationsEnabled = !notificationsEnabled;
          localStorage.setItem(
            "notificationsEnabled",
            notificationsEnabled.toString()
          );

          if (notificationsEnabled) {
            alert("âœ… é€šçŸ¥å·²é–‹å•Ÿ\næ‚¨å°‡æœƒæ”¶åˆ°æ–°è¨Šæ¯çš„é€šçŸ¥");
            // è¨»å†Š Push
            if (myName) {
              registerPush();
            }
          } else {
            alert("ğŸ”• é€šçŸ¥å·²é—œé–‰\næ‚¨å°‡ä¸æœƒæ”¶åˆ°æ–°è¨Šæ¯é€šçŸ¥");
          }

          updateNotifyBtn();
        } else if (Notification.permission === "denied") {
          alert(
            "âŒ é€šçŸ¥æ¬Šé™å·²è¢«å°é–\n\nè«‹åˆ°ç€è¦½å™¨è¨­å®šä¸­æ‰‹å‹•å…è¨±é€šçŸ¥æ¬Šé™ï¼š\n1. é»æ“Šç¶²å€åˆ—å·¦é‚Šçš„é–é ­åœ–ç¤º\n2. å°‡ã€Œé€šçŸ¥ã€æ”¹ç‚ºã€Œå…è¨±ã€\n3. é‡æ–°æ•´ç†ç¶²é "
          );
        }
      }

      // æ›´æ–°é€šçŸ¥æŒ‰éˆ•ç‹€æ…‹
      function updateNotifyBtn() {
        const btn = document.getElementById("btn-notify");
        if (!btn) return;

        if (Notification.permission === "granted" && notificationsEnabled) {
          btn.style.background = "#28a745"; // ç¶ è‰²ï¼šå·²é–‹å•Ÿ
          btn.style.color = "white";
          btn.title = "é€šçŸ¥å·²é–‹å•Ÿï¼ˆé»æ“Šé—œé–‰ï¼‰";
        } else if (
          Notification.permission === "granted" &&
          !notificationsEnabled
        ) {
          btn.style.background = "#6c757d"; // ç°è‰²ï¼šå·²é—œé–‰
          btn.style.color = "white";
          btn.title = "é€šçŸ¥å·²é—œé–‰ï¼ˆé»æ“Šé–‹å•Ÿï¼‰";
        } else if (Notification.permission === "denied") {
          btn.style.background = "#dc3545"; // ç´…è‰²ï¼šè¢«æ‹’çµ•
          btn.style.color = "white";
          btn.title = "é€šçŸ¥å·²æ‹’çµ•ï¼ˆé»æ“ŠæŸ¥çœ‹èªªæ˜ï¼‰";
        } else {
          btn.style.background = "transparent"; // é€æ˜ï¼šå°šæœªè¨­å®š
          btn.style.color = "white";
          btn.title = "é»æ“Šé–‹å•Ÿé€šçŸ¥";
        }
      }

      // é é¢è¼‰å…¥æ™‚æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      window.addEventListener("load", () => {
        updateNotifyBtn();
      });

      // === PWA Installation Logic ===
      let deferredPrompt;

      // Detect if user is on mobile
      const isMobile =
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        );

      // Show install button on mobile by default (since beforeinstallprompt may not fire)
      if (isMobile) {
        const installBtn = document.getElementById("install-btn");
        if (installBtn) {
          installBtn.classList.remove("d-none");
        }
      }

      window.addEventListener("beforeinstallprompt", (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        // Show the install button
        const installBtn = document.getElementById("install-btn");
        if (installBtn) {
          installBtn.classList.remove("d-none");
        }
        console.log("PWA install prompt is ready");
      });

      async function installApp() {
        if (!deferredPrompt) {
          // Fallback for browsers that don't support beforeinstallprompt
          if (isMobile) {
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
              alert(
                "ğŸ“² iOS å®‰è£æ–¹å¼ï¼š\n\n1. é»æ“Šä¸‹æ–¹çš„ã€Œåˆ†äº«ã€æŒ‰éˆ• (æ–¹æ¡†+ç®­é ­)\n2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n3. é»æ“Šã€Œæ–°å¢ã€å®Œæˆå®‰è£"
              );
            } else {
              alert(
                "ğŸ“² Android å®‰è£æ–¹å¼ï¼š\n\n1. é»æ“Šç€è¦½å™¨å³ä¸Šè§’çš„ã€Œâ‹®ã€é¸å–®\n2. é¸æ“‡ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€\n3. ç¢ºèªå®‰è£"
              );
            }
          } else {
            alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®‰è£åŠŸèƒ½ï¼Œæˆ– App å·²ç¶“å®‰è£éäº† ğŸ˜Š");
          }
          return;
        }

        // Show the install prompt
        deferredPrompt.prompt();

        // Wait for the user to respond to the prompt
        const { outcome } = await deferredPrompt.userChoice;

        if (outcome === "accepted") {
          console.log("User accepted the install prompt");
          alert("âœ… å®‰è£æˆåŠŸï¼App å·²æ–°å¢åˆ°æ‚¨çš„ä¸»ç•«é¢");
        } else {
          console.log("User dismissed the install prompt");
        }

        // Clear the deferredPrompt so it can only be used once
        deferredPrompt = null;

        // Hide the install button
        const installBtn = document.getElementById("install-btn");
        if (installBtn) {
          installBtn.classList.add("d-none");
        }
      }

      // === é™¤éŒ¯åŠŸèƒ½ï¼šæ¸¬è©¦é¡é ­ ===
      async function testCamera() {
        try {
          // æ”¹ç”¨å°è£å¥½çš„å‡½å¼
          const stream = await getLocalStream();
          alert("âœ… æ¸¬è©¦æˆåŠŸï¼\n(æ¸¬è©¦å¾Œæœƒè‡ªå‹•é—œé–‰)");
          stream.getTracks().forEach((t) => t.stop());
        } catch (e) {
          alert("âŒ æ¸¬è©¦å¤±æ•—: " + e.message);
        }
      }
    </script>
  </body>
</html>
